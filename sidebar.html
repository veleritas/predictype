<!DOCTYPE html>
<html>
  <head>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-MfvZlkHCEqatNoGiOXveE8FIwMzZg4W85qfrfIFBfYc= sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">
  </head>
  <body>

    <h3 id="header">Biomedical Ontology</h3>
    <h3 id="subheader"><small>Select text to get started...</small></h3>

    <div id="selected" style="display:none;">
      <h3><small>Selected text:</small></h3>
      <p></p>
    </div>

    <div id="yolo">
    </div>

    <div class="progress" id="progressBar" style="display:none;">
      <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
      </div>
    </div>

    <button id="query_button" class="btn btn-primary">Make query</button>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js">
    </script>

    <script>
      $(function() {
        console.log("init");
        $('#query_button').click(make_query);
      });

      function make_query() {
        console.log("inside make query");
        this.disabled = true;

        google.script.run
          .withSuccessHandler(
            function(return_value, element) {

              console.log("it worked");
              console.log(return_value);

              $('#subheader').hide();
              $('#yolo').html('Querying Bioontology...');

              $('#progressBar').show();

              get_suggestions(return_value);

              element.disabled = false;
            })
          .withFailureHandler(
            function(msg, element) {
              element.disabled = false;
              $('#progressBar').hide();
              console.log("failed");
              console.log(msg);
            })
          .withUserObject(this)
          .get_selected_text();

        console.log("end of make query");
      }

      function get_suggestions(text) {


          var queryText = text.toString();
          var topFiveResults = query_ncbo(queryText);

      }

      function query_ncbo(text) {

          var urlAddress = "//data.bioontology.org/search";
          var apiKey = "ef3fb12d-cbe4-44a6-8273-263cf896e87b";
          var params = {
              "api_key" : apiKey,
              "ontologies" : "MESH",
              // "suggest": True,
              "also_search_obsolete": false,
              "q" : text,
              "format": "jsonp"

          };
          var topFive = [];

          $.ajax({
              url: urlAddress,
              dataType: 'jsonp',
              data: params, 
              success: function(data){
                  var text = '';
                  var len = data['collection'].length;
                  console.log(len);
                  console.log(data);

                  if (len <= 5) {
                    // return all
                    for(var i=0;i<len;i++){
                      topFive.push(data['collection'][i]);
                    }
                  } else {
                    // return top 5
                    for(var i=0;i<5;i++){
                      topFive.push(data['collection'][i]);
                    }

                  }

                  process_results(topFive);

              },
              error: function(data){
                  console.log("error");
              }
          });

      }

      function process_results(topFive) {

        var topFiveString = "<ul>\n";
        for (var i=0; i<topFive.length; i++) {
          // topFiveString += "\n"+JSON.stringify(topFive[i]);
          topFiveString += "<li><a href=\""+
                            topFive[i]['@id']+
                            "\">"+
                            topFive[i]['prefLabel']+
                            "</li>";
        }

        topFiveString += "</ul>";

        $('#progressBar').hide();
        $('#yolo').html(topFiveString);
      }

    </script>

  </body>
</html>
